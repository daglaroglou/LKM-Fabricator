name: Patch SUKISU

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot image'
        required: false
        type: string
      image_base64:
        description: 'Base64 encoded boot image'
        required: false
        type: string
      patcher_type:
        description: 'Patcher type'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          echo "Downloading image from URL..."
          curl -L -o boot.img "${{ inputs.image_url }}"
          ls -lh boot.img

      - name: Decode base64 image
        if: ${{ inputs.image_base64 != '' }}
        run: |
          echo "Decoding base64 image..."
          echo "${{ inputs.image_base64 }}" | base64 -d > boot.img
          ls -lh boot.img

      - name: Verify image file
        run: |
          if [ ! -f boot.img ]; then
            echo "Error: boot.img not found!"
            exit 1
          fi
          file boot.img
          ls -lh boot.img

      - name: Download SUKISU
        run: |
          echo "Downloading SUKISU patcher..."
          # SUKISU (fork of KernelSU)
          SUKISU_VERSION=$(curl -s https://api.github.com/repos/dabao1955/kernel_su/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest SUKISU version: $SUKISU_VERSION"
          
          # Download sukisu tool
          curl -L -o sukisu "https://github.com/dabao1955/kernel_su/releases/download/${SUKISU_VERSION}/sukisu_x86_64-linux"
          chmod +x sukisu
          ./sukisu --version || echo "SUKISU tool ready"

      - name: Patch boot image
        run: |
          echo "Patching boot image with SUKISU..."
          ./sukisu boot-patch -b boot.img -o boot-patched.img
          
          if [ -f boot-patched.img ]; then
            echo "Patching successful!"
            ls -lh boot-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      - name: Upload patched image
        uses: actions/upload-artifact@v4
        with:
          name: boot-sukisu-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
