name: Patch SukiSU Ultra

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot/init_boot image'
        required: false
        type: string
      patcher_type:
        description: 'Patcher type'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup the environment
        run: |
          sudo apt install -y libarchive-tools
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          # source ~/.bashrc
          source ~/.profile
          rustup component add cargo
          rustup toolchain install stable
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin
          sudo ln -sf ~/.rustup/toolchains/stable-$(uname -m)-unknown-linux-gnu/bin/rustc /usr/bin/rustc
          sudo ln -sf ~/.rustup/toolchains/stable-$(uname -m)-unknown-linux-gnu/bin/cargo /usr/bin/cargo
          source ~/.profile
          RUSTFLAGS="" cargo install cross --git https://github.com/cross-rs/cross --rev 66845c1

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          echo "Downloading image from URL..."
          aria2c "${{ inputs.image_url }}" -o ./partition.img
          ls -lh ./partition.img

      - name: Verify image file
        run: |
          if [ ! -f partition.img ]; then
            echo "Error: partition.img not found!"
            exit 1
          fi
          file ./partition.img
          ls -lh ./partition.img

      - name: Download necessary tools
        run: |
          echo "Compiling SukiSU Ultra patcher..."
          # Using the latest release tag
          KERNELSU_VERSION=$(curl -s https://api.github.com/repos/SukiSU-Ultra/SukiSU-Ultra/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest SukiSU Ultra version: $KERNELSU_VERSION"

          # Compile ksud
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra.git -b $KERNELSU_VERSION ksu_driver
          cd ksu_driver/
          CROSS_NO_WARNINGS=0 cross build --target $(uname -m)-unknown-linux-musl --release --manifest-path ./userspace/ksud/Cargo.toml
          cp ./userspace/ksud/target/**/release/ksud* ./ksud

          echo "Downloading magiskboot..."
          # Using latest Magisk release
          MAGISK_VERSION=$(curl -s https://api.github.com/repos/topjohnwu/Magisk/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest Magisk version (for magiskboot tool, mandatory for patching): $MAGISK_VERSION"

          # Download magiskboot tool
          curl -LsSf "https://github.com/topjohnwu/Magisk/releases/download/${MAGISK_VERSION}/Magisk-${MAGISK_VERSION}.apk" | bsdtar -xvOf - lib/x86_64/libmagiskboot.so > ./magiskboot
          chmod a+x ./magiskboot

      - name: Patch boot image
        run: |
          echo "Check whether the provided image is an init_boot image or a regular boot image..."
          # Unpack header info and parse line by line
          while read -r key val; do
              case "$key" in
                  "HEADER_VER") V=${val//[\[\]]} ;;
                  "RAMDISK_SZ") R=${val//[\[\]]} ;;
          esac
          done < <(./magiskboot unpack -h "./partition.img" 2>&1)

          # Logic: init_boot or vendor_boot must have Header 4+ and a ramdisk size > 0
          mkdir images/
          if [[ ${V:-0} -ge 4 && ${R:-0} -gt 0 ]]; then
              echo "The provided image is an init_boot.img"
              #./ksud boot-patch --magiskboot ./magiskboot --kmi $KMI --module $KMI_kernelsu.ko --boot partition.img -o images/ # for lkm, wip
              #mv images/*.img init_boot-patched.img
          else
              echo "The provided image is an boot.img"
              ./ksud boot-patch --magiskboot ./magiskboot --boot partition.img -o images/
              mv images/*.img boot-patched.img
          fi

          if [ -f *-patched.img ]; then
            echo "Patching successful!"
            ls -lh *-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      - name: Upload patched image
        uses: actions/upload-artifact@v4
        with:
          name: boot-sukisu-ultra-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
