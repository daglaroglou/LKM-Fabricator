name: Patch KernelSU Next

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot/init_boot image'
        required: true
        type: string
      image_kmi:
        description: 'KMI of the device'
        required: true
        type: choice
        options:
          - 'android12-5.10'
          - 'android13-5.10'
          - 'android13-5.15'
          - 'android14-5.15'
          - 'android14-6.1'
          - 'android15-6.6'
          - 'android16-6.12'

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          sudo apt install -y libarchive-tools
          echo "Downloading image from URL..."
          aria2c "${{ inputs.image_url }}" -o ./partition.img
          ls -lh ./partition.img

      - name: Verify image file
        run: |
          if [ ! -f partition.img ]; then
            echo "Error: partition.img not found!"
            exit 1
          fi
          file ./partition.img
          ls -lh ./partition.img

      - name: Download necessary tools
        run: |
          echo "Downloading KernelSU Next patcher..."
          # Using the next branch
          KERNELSU_VERSION=$(curl -s https://api.github.com/repos/KernelSU-Next/KernelSU-Next/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest KernelSU Next version: $KERNELSU_VERSION"

          # Download ksu tool from next branch
          aria2c "https://github.com/KernelSU-Next/KernelSU-Next/releases/download/${KERNELSU_VERSION}/ksud-$(uname -m)-unknown-linux-musl" -o ./ksud
          chmod a+x ./ksud
          ./ksud --version || echo "KSU Next tool ready"

          echo "Downloading magiskboot..."
          # Download magiskboot tool
          curl -LsSf $(curl -sSf https://api.github.com/repos/KernelSU-Next/KernelSU-Next/releases/latest | grep browser_download_url | cut -d '"' -f 4 | grep -i ".apk"$) | bsdtar -xvOf - lib/x86_64/libmagiskboot.so > ./magiskboot
          chmod a+x ./magiskboot

      - name: Patch boot image
        id: image_patch
        run: |
          echo "Check whether the provided image is an init_boot image or a regular boot image..."
          # Unpack header info and parse line by line
          while read -r key val; do
              case "$key" in
                  "HEADER_VER") V=${val//[\[\]]} ;;
                  "RAMDISK_SZ") R=${val//[\[\]]} ;;
          esac
          done < <(./magiskboot unpack -h "./partition.img" 2>&1)

          # Logic: init_boot or vendor_boot must have Header 4+ and a ramdisk size > 0
          mkdir images/
          if [[ ${V:-0} -ge 4 && ${R:-0} -gt 0 ]]; then
              echo "image=init_boot" >> $GITHUB_OUTPUT
              echo "The provided image is an init_boot.img"
              ./ksud boot-patch --magiskboot ./magiskboot --kmi ${{ github.event.inputs.image_kmi }} --boot partition.img -o images/
              mv images/*.img init_boot-patched.img
          else
              echo "image=boot" >> $GITHUB_OUTPUT
              echo "The provided image is an boot.img"
              ./ksud boot-patch --magiskboot ./magiskboot --kmi ${{ github.event.inputs.image_kmi }} --boot partition.img -o images/
              mv images/*.img boot-patched.img
          fi

          if [ -f *-patched.img ]; then
            echo "Patching successful!"
            ls -lh *-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      - name: Upload patched init_boot image
        uses: actions/upload-artifact@v4
        if: steps.image_patch.outputs.image == 'init_boot'
        with:
          name: init_boot-kernelsu-next-patched-${{ github.run_id }}
          path: init_boot-patched.img
          retention-days: 1

      - name: Upload patched boot image
        uses: actions/upload-artifact@v4
        if: steps.image_patch.outputs.image == 'boot'
        with:
          name: boot-kernelsu-next-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
