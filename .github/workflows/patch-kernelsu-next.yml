name: Patch KernelSU Next

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot image'
        required: true
        type: string
      patcher_type:
        description: 'Patcher type'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          sudo apt install -y libarchive-tools
          echo "Downloading image from URL..."
          aria2c "${{ inputs.image_url }}" -o ./boot.img
          ls -lh ./boot.img

      - name: Verify image file
        run: |
          if [ ! -f boot.img ]; then
            echo "Error: boot.img not found!"
            exit 1
          fi
          file ./boot.img
          ls -lh ./boot.img

      - name: Download necessary tools
        run: |
          echo "Downloading KernelSU Next patcher..."
          # Using the next branch
          KERNELSU_VERSION=$(curl -s https://api.github.com/repos/KernelSU-Next/KernelSU-Next/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest KernelSU Next version: $KERNELSU_VERSION"

          # Download ksu tool from next branch
          aria2c "https://github.com/KernelSU-Next/KernelSU-Next/releases/download/${KERNELSU_VERSION}/ksud-$(uname -m)-unknown-linux-musl" -o ./ksud
          chmod a+x ./ksud
          ./ksud --version || echo "KSU Next tool ready"

          echo "Downloading magiskboot..."
          # Download magiskboot tool
          curl -LsSf $(curl -sSf https://api.github.com/repos/KernelSU-Next/KernelSU-Next/releases/latest | grep browser_download_url | cut -d '"' -f 4 | grep -i ".apk"$) | bsdtar -xvOf - lib/x86_64/libmagiskboot.so > ./magiskboot
          chmod a+x ./magiskboot

      - name: Patch boot image
        run: |
          echo "Patching boot image with KernelSU Next..."
          mkdir images/
          ./ksud boot-patch --magiskboot ./magiskboot --boot boot.img -o images/
          #./ksud boot-patch --magiskboot ./magiskboot --kmi $KMI --module $KMI_kernelsu.ko --boot boot.img -o images/ # for lkm, wip
          mv images/*.img "$(basename -s ".img" ${{ inputs.image_url }})-patched.img"

          if [ -f boot-patched.img ]; then
            echo "Patching successful!"
            ls -lh boot-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      - name: Upload patched image
        uses: actions/upload-artifact@v4
        with:
          name: boot-kernelsu-next-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
