name: Patch APatch

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot image'
        required: true
        type: string
      image_skey:
        description: 'APatch SuperKey password (no symbols)'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          sudo apt install -y libarchive-tools
          echo "Downloading image from URL..."
          aria2c "${{ inputs.image_url }}" -o ./partition.img
          ls -lh ./partition.img

      - name: Verify image file
        run: |
          if [ ! -f partition.img ]; then
            echo "Error: partition.img not found!"
            exit 1
          fi
          file ./partition.img
          ls -lh ./partition.img

      - name: Download necessary tools
        run: |
          echo "Downloading APatch/KernelPatch patcher..."
          # Using the latest release
          KERNELPATCH_VERSION=$(curl -s https://api.github.com/repos/bmax121/KernelPatch/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest KernelPatch version: $KERNELPATCH_VERSION"

          # Download kptools
          aria2c "https://github.com/bmax121/KernelPatch/releases/download/${KERNELPATCH_VERSION}/kptools-linux" -o ./kptools
          chmod a+x ./kptools
          if ./kptools --version; then echo "APatch/KernelPatch tool ready"; fi

          # Download kpimg
          aria2c "https://github.com/bmax121/KernelPatch/releases/download/${KERNELPATCH_VERSION}/kpimg-android"
          echo "APatch module ready"

          echo "Downloading magiskboot..."
          # Using latest Magisk APK
          MAGISK_VERSION=$(curl -s https://api.github.com/repos/topjohnwu/Magisk/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest Magisk version: $MAGISK_VERSION"

          # Download magiskboot tool
          curl -LsSf $(curl -sSf https://api.github.com/repos/topjohnwu/Magisk/releases/latest | grep browser_download_url | cut -d '"' -f 4 | grep -i ".apk"$) | bsdtar -xvOf - lib/x86_64/libmagiskboot.so > ./magiskboot
          chmod a+x ./magiskboot

      - name: Patch boot image
        id: image_patch
        run: |
          echo "Check whether the provided image is an init_boot image or a regular boot image..."
          # Unpack header info and parse line by line
          while read -r key val; do
              case "$key" in
                  "VENDOR_BOOT_HDR") VBOOT=1 ;;
                  "HEADER_VER") V=${val//[\[\]]} ;;
                  "RAMDISK_SZ") R=${val//[\[\]]} ;;
          esac
          done < <(./magiskboot unpack -h "./partition.img" 2>&1)

          # Logic: init_boot or vendor_boot must have Header 4+ and a ramdisk size > 0
          mkdir images/
          if [[ ${V:-0} -ge 4 && ${R:-0} -gt 0 ]]; then
              if [[ $VBOOT == 1 ]]; then
                echo "image=vendor_boot" >> $GITHUB_OUTPUT
                echo "The provided image is a vendor_boot.img, and is unsupported. Please provide a regular boot.img next time."
              else
                echo "image=init_boot" >> $GITHUB_OUTPUT
                echo "The provided image is an init_boot.img, and is unsupported. Please provide a regular boot.img next time."
              fi
              exit 1
          else
              echo "image=boot" >> $GITHUB_OUTPUT
              echo "The provided image is a boot.img"
              ./magiskboot unpack partition.img
              mv kernel kernel.orig
              ./kptools -p --image kernel.orig --skey "${{ github.event.inputs.image_skey }}" --kpimg kpimg-android --out kernel
              ./magiskboot repack partition.img boot-patched.img
          fi

          if [ -f *-patched.img ]; then
            echo "Patching successful!"
            ls -lh *-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      # - name: Upload patched vendor_boot image
      #   uses: actions/upload-artifact@v4
      #   if: steps.image_patch.outputs.image == 'vendor_boot'
      #   with:
      #     name: vendor_boot-apatch-patched-${{ github.run_id }}
      #     path: vendor_boot-patched.img
      #     retention-days: 1

      # - name: Upload patched init_boot image
      #   uses: actions/upload-artifact@v4
      #   if: steps.image_patch.outputs.image == 'init_boot'
      #   with:
      #     name: init_boot-apatch-patched-${{ github.run_id }}
      #     path: init_boot-patched.img
      #     retention-days: 1

      - name: Upload patched boot image
        uses: actions/upload-artifact@v4
        if: steps.image_patch.outputs.image == 'boot'
        with:
          name: boot-apatch-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
