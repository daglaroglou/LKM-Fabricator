name: Patch APatch

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL to boot image'
        required: false
        type: string
      image_base64:
        description: 'Base64 encoded boot image'
        required: false
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image from URL
        if: ${{ inputs.image_url != '' }}
        run: |
          echo "Downloading image from URL..."
          curl -L -o boot.img "${{ inputs.image_url }}"
          ls -lh boot.img

      - name: Decode base64 image
        if: ${{ inputs.image_base64 != '' }}
        run: |
          echo "Decoding base64 image..."
          echo "${{ inputs.image_base64 }}" | base64 -d > boot.img
          ls -lh boot.img

      - name: Verify image file
        run: |
          if [ ! -f boot.img ]; then
            echo "Error: boot.img not found!"
            exit 1
          fi
          file boot.img
          ls -lh boot.img

      - name: Download APatch
        run: |
          echo "Downloading APatch patcher..."
          APATCH_VERSION=$(curl -s https://api.github.com/repos/bmax121/APatch/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          echo "Latest APatch version: $APATCH_VERSION"
          
          # Download apatch tool
          curl -L -o apatch "https://github.com/bmax121/APatch/releases/download/${APATCH_VERSION}/apatch_x86_64-linux"
          chmod +x apatch
          ./apatch --version || echo "APatch tool ready"

      - name: Patch boot image
        run: |
          echo "Patching boot image with APatch..."
          ./apatch boot-patch -b boot.img -o boot-patched.img
          
          if [ -f boot-patched.img ]; then
            echo "Patching successful!"
            ls -lh boot-patched.img
          else
            echo "Error: Patched image not found!"
            exit 1
          fi

      - name: Upload patched image
        uses: actions/upload-artifact@v4
        with:
          name: boot-apatch-patched-${{ github.run_id }}
          path: boot-patched.img
          retention-days: 1

      - name: Patch complete
        run: |
          echo "âœ… Patching complete!"
          echo "Artifact will be available for 1 day"
          echo "Run ID: ${{ github.run_id }}"
